# 过期时间修复验证指南

## 🎯 验证目标

确认 Token 导入功能能够正确显示账户过期时间,不再显示"未知"。

## 📋 验证步骤

### 步骤 1: 编译应用

```bash
cd Verdent_account_manger
npm run tauri dev
```

### 步骤 2: 导入测试 Token

使用以下测试 Token:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo3NDk0NjI4NTU5MzIxNDk3NjAsInZlcnNpb24iOjAsInRva2VuX3R5cGUiOiJhY2Nlc3MiLCJleHAiOjE3NjU3MDk0MjksImlhdCI6MTc2MzExNzQyOSwibmJmIjoxNzYzMTE3NDI5fQ.3Nb7K7V56ypYbgj5ESWgoGjC2NRUBhvkVyMLsnB9btE
```

**操作**:
1. 点击 "📥 导入 Token" 按钮
2. 粘贴上述 Token
3. 点击 "开始导入"
4. 等待导入完成

### 步骤 3: 检查账户信息

在账户卡片中查看以下字段:

#### ✅ 应该正确显示的字段:

1. **邮箱**: `emma.jones2165@chitthi.in`
2. **订阅类型**: `Free`
3. **额度信息**:
   - 剩余: 100.00
   - 已用: 0.00
   - 总计: 100.00
4. **过期时间**: `2025/01/17 02:50` (或类似时间,取决于时区)
   - ⚠️ **关键验证点**: 不应该显示"未知"!
5. **订阅到期时间**: `2025/01/17` (简化格式)
6. **自动续订**: 否

### 步骤 4: 查看后端日志

在控制台中应该看到类似的日志:

```
[*] ========== 导入 Token 账户 ==========
[*] Token 长度: 215 字符
[*] 使用 Token 获取用户信息...
[✓] 成功获取用户信息
[*] 账户邮箱: emma.jones2165@chitthi.in
[*] 额度信息:
    已消耗: 0.00
    总额度: 100.00
    剩余: 100.00
[*] 订阅信息:
    类型: Some("Free")
    周期结束: Some(1763722204)
    自动续订: false
    试用天数: None
    过期时间: Some("2025-01-16T18:50:04+00:00")  ← 应该有值!
[*] 创建新账户...
[✓] 新账户已创建
[✓] Token 导入成功: emma.jones2165@chitthi.in
======================================
```

**关键验证点**:
- ✅ `过期时间: Some("2025-01-16T18:50:04+00:00")` - 有值
- ❌ `过期时间: None` - 修复前的错误状态

## 🧪 额外测试

### 测试 1: 刷新账户信息

1. 点击账户卡片的 "🔄" 刷新按钮
2. 等待刷新完成
3. 验证过期时间仍然正确显示

**预期结果**:
- ✅ 过期时间保持正确
- ✅ 其他信息也已更新

### 测试 2: 测试登录 (如果有密码)

1. 编辑账户,添加密码
2. 点击 "🔑 测试登录" 按钮
3. 等待登录完成
4. 验证过期时间仍然正确显示

**预期结果**:
- ✅ Token 已更新
- ✅ 过期时间保持正确

### 测试 3: 重启应用

1. 关闭应用
2. 重新启动应用
3. 查看导入的账户

**预期结果**:
- ✅ 过期时间持久化保存
- ✅ 重启后仍然正确显示

## 📊 数据验证

### 时间戳转换验证

**原始数据**:
- `currentPeriodEnd`: `1763722204` (Unix 时间戳,秒)

**转换后**:
- RFC3339: `2025-01-16T18:50:04+00:00`
- 本地时间 (UTC+8): `2025/01/17 02:50`

**验证工具**:
```python
import datetime
timestamp = 1763722204
dt = datetime.datetime.fromtimestamp(timestamp, tz=datetime.timezone.utc)
print(f"UTC: {dt}")
print(f"RFC3339: {dt.isoformat()}")

# 转换为本地时区 (UTC+8)
local_dt = dt.astimezone(datetime.timezone(datetime.timedelta(hours=8)))
print(f"Local (UTC+8): {local_dt}")
```

**输出**:
```
UTC: 2025-01-16 18:50:04+00:00
RFC3339: 2025-01-16T18:50:04+00:00
Local (UTC+8): 2025-01-17 02:50:04+08:00
```

## ✅ 验证清单

- [ ] 应用成功编译并启动
- [ ] Token 导入成功
- [ ] 账户邮箱正确显示
- [ ] 订阅类型正确显示
- [ ] 额度信息正确显示
- [ ] **过期时间不再显示"未知"** ⭐
- [ ] 过期时间显示为合理的日期 (2025年)
- [ ] 订阅到期时间正确显示
- [ ] 后端日志显示过期时间有值
- [ ] 刷新功能正常工作
- [ ] 数据持久化保存

## 🐛 问题排查

### 问题 1: 过期时间仍然显示"未知"

**可能原因**:
1. 代码未重新编译
2. 使用了旧的构建版本

**解决方法**:
```bash
# 清理并重新构建
npm run tauri build
# 或重新启动开发服务器
npm run tauri dev
```

### 问题 2: 过期时间显示为 1970 年

**可能原因**:
- 时间戳转换错误
- 使用了毫秒而非秒

**检查**:
- 确认 `currentPeriodEnd` 是秒级时间戳
- 检查 `chrono::DateTime::from_timestamp` 的参数

### 问题 3: 后端日志显示 `过期时间: None`

**可能原因**:
- API 未返回 `currentPeriodEnd`
- Token 已过期或无效

**解决方法**:
1. 使用 `test/test_api_response.py` 验证 API 响应
2. 检查 Token 是否有效
3. 查看完整的 API 响应日志

## 📝 验证报告模板

```
验证日期: ____________________
验证人: ____________________

测试环境:
- 操作系统: Windows 10
- 应用版本: 1.0.0
- 测试 Token: eyJhbGci...

测试结果:
✅ Token 导入成功
✅ 过期时间正确显示: 2025/01/17 02:50
✅ 后端日志正确: Some("2025-01-16T18:50:04+00:00")
✅ 刷新功能正常
✅ 数据持久化正常

问题记录:
(无)

结论:
修复成功,过期时间显示问题已解决。
```

## 🎉 验证成功标准

当满足以下所有条件时,验证通过:

1. ✅ Token 导入后,过期时间字段显示具体日期
2. ✅ 过期时间不显示"未知"
3. ✅ 后端日志显示 `过期时间: Some("...")`
4. ✅ 刷新和测试登录功能正常
5. ✅ 数据持久化保存正确

## 📞 需要帮助?

如果验证过程中遇到问题:
1. 查看 [修复文档](../docs/EXPIRE_TIME_FIX.md)
2. 检查后端控制台日志
3. 运行 `test/test_api_response.py` 验证 API
4. 查看 `accounts.json` 文件内容

