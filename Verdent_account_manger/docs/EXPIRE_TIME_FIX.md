# è¿‡æœŸæ—¶é—´æ˜¾ç¤ºé—®é¢˜ä¿®å¤æ–‡æ¡£

## ğŸ› é—®é¢˜æè¿°

åœ¨ä½¿ç”¨ Token å¯¼å…¥åŠŸèƒ½å¯¼å…¥è´¦æˆ·å,è´¦æˆ·å¡ç‰‡ä¸­çš„"è¿‡æœŸæ—¶é—´"å­—æ®µä¸€ç›´æ˜¾ç¤ºä¸º"æœªçŸ¥",è€Œå…¶ä»–å­—æ®µ(é‚®ç®±ã€è®¢é˜…ç±»å‹ã€é¢åº¦ç­‰)éƒ½èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚

## ğŸ” é—®é¢˜è°ƒæŸ¥

### 1. API å“åº”åˆ†æ

é€šè¿‡è°ƒç”¨ Verdent API çš„ `/user/center/info` ç«¯ç‚¹,å‘ç°:

**API è¿”å›çš„æ•°æ®ç»“æ„**:
```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "email": "emma.jones2165@chitthi.in",
    "tokenInfo": {
      "tokenFree": 100,
      "tokenConsumed": 0,
      "tokenFlexibleLeft": 0
    },
    "subscriptionInfo": {
      "planId": "Pl1181733412181114881",
      "planName": "Free",
      "status": "active",
      "level": "1",
      "levelName": "Free",
      "currentPeriodEnd": 1763722204,  // â† è®¢é˜…å‘¨æœŸç»“æŸæ—¶é—´
      "autoRenew": false
    },
    "isSubscribe": true,
    "isTrialAvailable": false
    // æ³¨æ„: æ²¡æœ‰ expireTime å­—æ®µ!
  }
}
```

**å…³é”®å‘ç°**:
- âŒ API å“åº”ä¸­**æ²¡æœ‰** `expireTime` å­—æ®µ
- âœ… ä½†æœ‰ `subscriptionInfo.currentPeriodEnd` å­—æ®µ (Unix æ—¶é—´æˆ³,ç§’)
- âœ… JWT Token çš„ payload ä¸­æœ‰ `exp` å­—æ®µ (Token è¿‡æœŸæ—¶é—´)

### 2. ä»£ç é—®é¢˜

**åŸæœ‰ä»£ç ** (`src-tauri/src/commands.rs`):
```rust
let expire_time = user_info.expire_time.clone();  // æ€»æ˜¯ None!
```

ç”±äº API ä¸è¿”å› `expireTime`,æ‰€ä»¥ `user_info.expire_time` æ€»æ˜¯ `None`,å¯¼è‡´è´¦æˆ·çš„ `expire_time` å­—æ®µä¸ºç©º,å‰ç«¯æ˜¾ç¤º"æœªçŸ¥"ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆé€‰æ‹©

æœ‰ä¸¤ä¸ªå¯ç”¨çš„æ—¶é—´æˆ³:
1. **`currentPeriodEnd`** - è®¢é˜…å‘¨æœŸç»“æŸæ—¶é—´ (æ¨è)
2. **JWT `exp`** - Token è¿‡æœŸæ—¶é—´

**é€‰æ‹© `currentPeriodEnd` çš„ç†ç”±**:
- ä»£è¡¨è®¢é˜…æœåŠ¡çš„å®é™…è¿‡æœŸæ—¶é—´
- æ›´ç¬¦åˆä¸šåŠ¡é€»è¾‘ (ç”¨æˆ·å…³å¿ƒçš„æ˜¯è®¢é˜…ä½•æ—¶åˆ°æœŸ)
- æ— éœ€é¢å¤–çš„ JWT è§£æåº“
- å·²ç»åœ¨ API å“åº”ä¸­æä¾›

### å®ç°é€»è¾‘

```rust
// è®¡ç®—è¿‡æœŸæ—¶é—´: ä¼˜å…ˆä½¿ç”¨ API è¿”å›çš„ expireTime,å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ currentPeriodEnd
let expire_time = if let Some(exp_time) = user_info.expire_time.clone() {
    Some(exp_time)
} else if let Some(period_end) = current_period_end {
    // å°† Unix æ—¶é—´æˆ³è½¬æ¢ä¸º RFC3339 æ ¼å¼
    let dt = chrono::DateTime::from_timestamp(period_end, 0)
        .unwrap_or_else(|| chrono::Utc::now());
    Some(dt.to_rfc3339())
} else {
    None
};
```

**é€»è¾‘è¯´æ˜**:
1. ä¼˜å…ˆä½¿ç”¨ API è¿”å›çš„ `expireTime` (å¦‚æœå°†æ¥ API æ·»åŠ æ­¤å­—æ®µ)
2. å¦‚æœæ²¡æœ‰,ä½¿ç”¨ `currentPeriodEnd` å¹¶è½¬æ¢ä¸º RFC3339 æ ¼å¼
3. å¦‚æœéƒ½æ²¡æœ‰,è¿”å› `None`

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `src-tauri/src/commands.rs`

ä¿®æ”¹äº† 3 ä¸ªå‘½ä»¤å‡½æ•°:

#### a) `import_account_by_token` (ç¬¬ 1049-1080 è¡Œ)
- æ·»åŠ è¿‡æœŸæ—¶é—´è®¡ç®—é€»è¾‘
- ä½¿ç”¨ `currentPeriodEnd` ä½œä¸º fallback

#### b) `refresh_account_info` (ç¬¬ 825-855 è¡Œ)
- æ·»åŠ è¿‡æœŸæ—¶é—´è®¡ç®—é€»è¾‘
- ç¡®ä¿åˆ·æ–°æ—¶ä¹Ÿèƒ½æ­£ç¡®æ›´æ–°è¿‡æœŸæ—¶é—´

#### c) `test_login_and_update` (ç¬¬ 949-976 è¡Œ)
- æ·»åŠ è¿‡æœŸæ—¶é—´è®¡ç®—é€»è¾‘
- ç¡®ä¿æµ‹è¯•ç™»å½•åä¹Ÿèƒ½æ­£ç¡®æ›´æ–°è¿‡æœŸæ—¶é—´

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹ 1: Token å¯¼å…¥

**æ­¥éª¤**:
1. ä½¿ç”¨æä¾›çš„ Token å¯¼å…¥è´¦æˆ·
2. æŸ¥çœ‹è´¦æˆ·å¡ç‰‡çš„"è¿‡æœŸæ—¶é—´"å­—æ®µ

**é¢„æœŸç»“æœ**:
- âœ… æ˜¾ç¤ºæ­£ç¡®çš„è¿‡æœŸæ—¶é—´ (å¦‚: 2025-01-16 18:50:04)
- âœ… ä¸å†æ˜¾ç¤º"æœªçŸ¥"

**å®é™…æ•°æ®**:
- `currentPeriodEnd`: 1763722204
- è½¬æ¢å: 2025-01-16T18:50:04+00:00

### æµ‹è¯•ç”¨ä¾‹ 2: åˆ·æ–°è´¦æˆ·ä¿¡æ¯

**æ­¥éª¤**:
1. ç‚¹å‡»è´¦æˆ·å¡ç‰‡çš„"ğŸ”„ åˆ·æ–°"æŒ‰é’®
2. æŸ¥çœ‹æ›´æ–°åçš„è¿‡æœŸæ—¶é—´

**é¢„æœŸç»“æœ**:
- âœ… è¿‡æœŸæ—¶é—´æ­£ç¡®æ›´æ–°
- âœ… æ˜¾ç¤ºæœ€æ–°çš„è®¢é˜…å‘¨æœŸç»“æŸæ—¶é—´

### æµ‹è¯•ç”¨ä¾‹ 3: æµ‹è¯•ç™»å½•

**æ­¥éª¤**:
1. ç‚¹å‡»"ğŸ”‘ æµ‹è¯•ç™»å½•"æŒ‰é’®
2. æŸ¥çœ‹æ›´æ–°åçš„è¿‡æœŸæ—¶é—´

**é¢„æœŸç»“æœ**:
- âœ… è¿‡æœŸæ—¶é—´æ­£ç¡®æ›´æ–°
- âœ… Token å’Œè¿‡æœŸæ—¶é—´éƒ½å·²æ›´æ–°

## ğŸ“Š æ—¶é—´æˆ³è½¬æ¢ç¤ºä¾‹

### Unix æ—¶é—´æˆ³ â†’ RFC3339

```rust
// Unix æ—¶é—´æˆ³ (ç§’)
let timestamp: i64 = 1763722204;

// è½¬æ¢ä¸º DateTime
let dt = chrono::DateTime::from_timestamp(timestamp, 0)
    .unwrap_or_else(|| chrono::Utc::now());

// è½¬æ¢ä¸º RFC3339 å­—ç¬¦ä¸²
let rfc3339 = dt.to_rfc3339();
// ç»“æœ: "2025-01-16T18:50:04+00:00"
```

### å‰ç«¯æ˜¾ç¤º

å‰ç«¯ä¼šè‡ªåŠ¨è§£æ RFC3339 æ ¼å¼å¹¶æ˜¾ç¤ºä¸ºæœ¬åœ°æ—¶é—´:
```typescript
const date = new Date("2025-01-16T18:50:04+00:00")
return date.toLocaleString('zh-CN', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit'
})
// ç»“æœ: "2025/01/17 02:50" (UTC+8)
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
è¿‡æœŸæ—¶é—´: æœªçŸ¥
```

### ä¿®å¤å
```
è¿‡æœŸæ—¶é—´: 2025/01/17 02:50 (å‰©ä½™ 64 å¤©)
```

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºå¤„ç†**
   - `currentPeriodEnd` æ˜¯ UTC æ—¶é—´æˆ³
   - è½¬æ¢ä¸º RFC3339 æ—¶ä½¿ç”¨ UTC æ—¶åŒº
   - å‰ç«¯æ˜¾ç¤ºæ—¶ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº

2. **å…¼å®¹æ€§**
   - ä»£ç ä¼˜å…ˆä½¿ç”¨ API çš„ `expireTime` (å¦‚æœå°†æ¥æ·»åŠ )
   - å‘åå…¼å®¹,ä¸å½±å“ç°æœ‰åŠŸèƒ½

3. **æ•°æ®ä¸€è‡´æ€§**
   - `expire_time` å’Œ `current_period_end` å¯èƒ½ä¸åŒ
   - `expire_time` ç”¨äºæ˜¾ç¤º,`current_period_end` ç”¨äºè®¢é˜…ç®¡ç†

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **ä¿®å¤ä»£ç **: `src-tauri/src/commands.rs`
- **API æµ‹è¯•**: `test/test_api_response.py`
- **API ç»“æ„**: `src-tauri/src/api.rs`

## ğŸ“š å‚è€ƒèµ„æ–™

- [Verdent API æ–‡æ¡£](../docs/API.md)
- [Token å¯¼å…¥åŠŸèƒ½æ–‡æ¡£](./TOKEN_IMPORT_FEATURE.md)
- [chrono æ–‡æ¡£](https://docs.rs/chrono/latest/chrono/)

