# Verdent 账号管理器 - 管理员权限解决方案

## 🔴 问题说明

错误信息：
```
应用程序无法启动，因为应用程序的并行配置不正确 (os error 14001)
```

这个错误通常是由于：
1. 应用程序清单配置不当
2. 缺少 Visual C++ 运行时库
3. 权限设置冲突

## ✅ 解决方案

### 方案一：使用批处理文件启动（推荐）

我们创建了两个批处理文件来处理管理员权限：

#### 1. `run_as_admin.bat` - 运行发布版本
- 自动检测是否有管理员权限
- 如果没有，自动请求权限
- 启动应用程序

**使用方法：**
1. 双击 `run_as_admin.bat`
2. 在 UAC 对话框中点击"是"
3. 应用自动启动

#### 2. `dev_as_admin.bat` - 开发模式
- 以管理员权限启动开发服务器
- 用于开发和调试

**使用方法：**
1. 双击 `dev_as_admin.bat`  
2. 在 UAC 对话框中点击"是"
3. 开发服务器自动启动

### 方案二：创建快捷方式

1. 找到 `verdent-account-manager.exe`
2. 右键 → 创建快捷方式
3. 右键快捷方式 → 属性
4. 点击"高级"按钮
5. 勾选"用管理员身份运行"
6. 确定保存

### 方案三：兼容性设置

1. 右键 `verdent-account-manager.exe`
2. 选择"属性"
3. 切换到"兼容性"标签
4. 勾选"以管理员身份运行此程序"
5. 点击"确定"

## 🔧 技术细节

### 为什么需要管理员权限？

1. **写入 Windows Credential Manager**
   - 保存和管理 Token
   - 需要访问系统凭据存储

2. **修改注册表机器码**
   - 重置设备标识符
   - 避免多账号检测

3. **管理系统进程**
   - 重启 Verdent 客户端
   - 终止和启动进程

### 权限检查机制

应用在启动时会自动检查权限：

```javascript
// 检查管理员权限
const hasAdmin = await invoke('check_admin_privileges')

if (!hasAdmin) {
  console.warn('应用未以管理员权限运行，某些功能可能受限')
}
```

### 智能权限提升

当需要管理员权限时，应用会：
1. 检测当前权限状态
2. 提示用户需要权限的原因
3. 引导用户获取权限

## 📦 依赖要求

### 必需的运行时库

确保已安装：
- **Visual C++ Redistributable 2015-2022**
  - [下载链接](https://aka.ms/vs/17/release/vc_redist.x64.exe)
  
- **.NET Framework 4.8**
  - Windows 10 通常已内置

### 检查运行时库

在命令提示符中运行：
```batch
wmic product get name | findstr "Visual C++"
```

## 🚀 快速启动指南

### 首次使用

1. **构建应用**
   ```bash
   npm run tauri build
   ```

2. **使用批处理启动**
   - 双击 `run_as_admin.bat`
   - 或者使用 `dev_as_admin.bat` 进行开发

3. **确认权限**
   - 在 UAC 提示中点击"是"

### 日常使用

- **开发模式**: 使用 `dev_as_admin.bat`
- **生产模式**: 使用 `run_as_admin.bat`
- **快速访问**: 将批处理文件固定到任务栏

## 🛠️ 故障排除

### 问题1：仍然出现并行配置错误

**解决方法：**
1. 安装最新的 Visual C++ Redistributable
2. 运行系统文件检查：
   ```batch
   sfc /scannow
   ```
3. 重新构建项目：
   ```bash
   cargo clean
   npm run tauri build
   ```

### 问题2：UAC 提示被拒绝

**解决方法：**
1. 确保当前用户有管理员组权限
2. 检查组策略设置
3. 临时禁用 UAC（不推荐）

### 问题3：应用无法访问凭据管理器

**解决方法：**
1. 确保 Windows Credential Manager 服务正在运行
2. 检查防火墙和杀毒软件设置
3. 重置凭据管理器：
   ```batch
   cmdkey /list
   cmdkey /delete:target
   ```

## 📝 最佳实践

### 1. 开发环境
- 始终使用 `dev_as_admin.bat` 启动开发服务器
- 在 VS Code 中以管理员身份打开项目

### 2. 生产部署
- 使用批处理文件或快捷方式
- 考虑使用任务计划程序自动启动
- 为企业用户提供 MSI 安装包

### 3. 用户体验
- 在应用中清晰说明为什么需要管理员权限
- 提供降级功能（部分功能可用）
- 记录权限请求日志

## 🔐 安全建议

1. **最小权限原则**
   - 只在必要时请求管理员权限
   - 提供非管理员模式选项

2. **代码签名**
   - 对可执行文件进行数字签名
   - 减少 UAC 警告

3. **审计日志**
   - 记录所有需要管理员权限的操作
   - 便于故障排除和安全审计

## 📞 支持

如果问题持续存在：
1. 检查 Windows 事件查看器中的错误日志
2. 运行 `sxstrace` 工具进行诊断
3. 联系技术支持
