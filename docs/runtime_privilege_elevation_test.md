# 运行时权限提升功能测试指南

## 功能概述

本文档描述如何测试 Verdent 账号管理器的**运行时权限提升**功能。该功能允许用户在普通权限下启动应用，仅在需要时才请求管理员权限。

## 测试场景

### 场景 1: 普通权限启动 → 重置机器码 → 权限提升

**测试步骤**：

1. **以普通用户身份启动应用**
   - 双击 `Verdent_account_manger.exe`（不要右键"以管理员身份运行"）
   - 应用应该正常启动，无 UAC 提示

2. **导航到存储管理页面**
   - 点击顶部的"存储管理"标签页
   - 滚动到"机器码管理"部分

3. **点击"重置机器码"按钮**
   - 应该弹出第一个对话框：
     ```
     🔒 需要管理员权限
     
     修改机器码需要写入系统注册表 (HKLM)，需要管理员权限。
     
     是否以管理员身份重启应用？
     
     注意：
     • 重启后将保留所有账号数据
     • 您需要在 UAC 提示中点击"是"
     ```

4. **点击"确定"**
   - 应该显示提示："正在请求管理员权限..."
   - 弹出 Windows UAC 对话框

5. **在 UAC 对话框中点击"是"**
   - 应用应该以管理员权限重新启动
   - 所有账号数据应该保留

6. **再次点击"重置机器码"**
   - 这次应该**不再**弹出权限提升对话框
   - 直接弹出确认对话框：
     ```
     ⚠️ 重置机器码
     
     此操作将:
     1. 生成新的随机机器码
     2. 写入系统注册表
     
     注意: 如果尚未备份,系统会自动备份当前机器码。
     
     是否继续?
     ```

7. **点击"确定"**
   - 机器码应该成功重置
   - 显示成功提示："✓ 机器码已重置为: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"

**预期结果**：
- ✅ 普通权限下启动应用不会弹出 UAC
- ✅ 需要权限时会提示用户
- ✅ 用户可以选择拒绝权限提升
- ✅ 权限提升后应用以管理员身份重启
- ✅ 重启后数据保留
- ✅ 有管理员权限后操作成功

---

### 场景 2: 用户拒绝权限提升

**测试步骤**：

1. 以普通用户身份启动应用
2. 点击"重置机器码"按钮
3. 在权限提升对话框中点击**"取消"**

**预期结果**：
- ✅ 显示提示："已取消操作"
- ✅ 应用继续正常运行
- ✅ 不执行重置操作

---

### 场景 3: 用户在 UAC 对话框中拒绝

**测试步骤**：

1. 以普通用户身份启动应用
2. 点击"重置机器码"按钮
3. 在权限提升对话框中点击"确定"
4. 在 Windows UAC 对话框中点击**"否"**

**预期结果**：
- ✅ 显示错误提示："权限提升失败: [错误信息]"
- ✅ 提示用户手动以管理员身份运行应用
- ✅ 应用不会崩溃

---

### 场景 4: 恢复机器码（同样需要权限）

**测试步骤**：

1. 以普通用户身份启动应用
2. 点击"恢复机器码"按钮
3. 应该弹出相同的权限提升对话框

**预期结果**：
- ✅ 权限检查逻辑与"重置机器码"一致
- ✅ 权限提升流程相同

---

### 场景 5: Verdent 客户端登录（需要权限）

**测试步骤**：

1. **以普通用户身份启动应用**
   - 双击 `Verdent_account_manger.exe`（不要右键"以管理员身份运行"）

2. **导航到账户管理页面**
   - 点击顶部的"账户管理"标签页
   - 确保至少有一个账户有 Token

3. **点击账户卡片下方的"Verdent 客户端登录"按钮**
   - 应该弹出第一个对话框：
     ```
     🔒 需要管理员权限

     登录到 Verdent 客户端需要:
     • 写入 Windows 凭据管理器
     • 修改系统注册表 (HKLM)
     • 重启 Verdent 客户端进程

     是否以管理员身份重启应用？

     注意：
     • 重启后将保留所有账号数据
     • 您需要在 UAC 提示中点击"是"
     ```

4. **点击"确定"**
   - 应该显示提示："正在请求管理员权限..."
   - 弹出 Windows UAC 对话框

5. **在 UAC 对话框中点击"是"**
   - 应用应该以管理员权限重新启动
   - 所有账号数据应该保留

6. **再次点击"Verdent 客户端登录"**
   - 这次应该**不再**弹出权限提升对话框
   - 直接弹出确认对话框：
     ```
     ⚠️ 登录到 Verdent 客户端

     此操作将:
     1. 写入 Token 到 Windows 凭据管理器
     2. 生成新的随机机器码并写入注册表
     3. 重启 Verdent 客户端

     ⚠️ 注意:
     - 如果尚未备份,系统会自动备份当前机器码
     - 会关闭当前运行的 Verdent 客户端

     是否继续?
     ```

7. **点击"确定"**
   - 应该成功登录到 Verdent 客户端
   - 显示成功提示："✅ 已成功登录到 Verdent 客户端"

**预期结果**：
- ✅ 普通权限下启动应用不会弹出 UAC
- ✅ 需要权限时会提示用户
- ✅ 用户可以选择拒绝权限提升
- ✅ 权限提升后应用以管理员身份重启
- ✅ 重启后数据保留
- ✅ 有管理员权限后操作成功
- ✅ Token 成功写入 Windows 凭据管理器
- ✅ 机器码成功重置
- ✅ Verdent 客户端成功重启

---

## 后端日志验证

在控制台中应该看到以下日志：

### 权限检查日志
```
[*] 管理员权限检查: 否
```
或
```
[*] 管理员权限检查: 是
```

### 机器码写入日志
```
[*] 准备写入机器码到注册表: XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
[✓] 机器码已成功写入注册表
```

### 权限不足错误日志
```
[×] 写入注册表失败: 拒绝访问
```

---

## 常见问题排查

### 问题 1: 权限提升后应用没有重启

**可能原因**：
- PowerShell 执行策略限制
- 应用路径包含特殊字符

**解决方案**：
- 检查 PowerShell 执行策略：`Get-ExecutionPolicy`
- 确保应用路径不包含中文或特殊字符

### 问题 2: UAC 对话框没有弹出

**可能原因**：
- UAC 已被禁用
- 用户已经是管理员

**解决方案**：
- 检查 UAC 设置：控制面板 → 用户账户 → 更改用户账户控制设置
- 确保 UAC 滑块不在最底部

### 问题 3: 权限提升后数据丢失

**可能原因**：
- 配置文件路径错误
- 文件权限问题

**解决方案**：
- 检查配置文件位置：`C:\Users\[用户名]\.verdent_accounts\`
- 确保该目录对所有用户可读写

---

## 技术实现细节

### 权限检测（Windows API）

使用 `GetTokenInformation` API 查询当前进程的令牌提升状态：

```rust
let mut elevation = TOKEN_ELEVATION { TokenIsElevated: 0 };
GetTokenInformation(token, TokenElevation, ...);
let is_admin = elevation.TokenIsElevated != 0;
```

### 权限提升（PowerShell + runas）

使用 PowerShell 的 `Start-Process -Verb RunAs` 启动新进程：

```rust
Start-Process -FilePath 'path\to\app.exe' -Verb RunAs
```

### 错误处理

- 权限检查失败 → 返回 `false`（假设无权限）
- 权限提升失败 → 返回友好的错误信息
- 注册表写入失败 → 检查错误信息中是否包含"拒绝访问"

---

## 总结

运行时权限提升功能确保了：
1. ✅ 应用默认以普通权限运行（更安全）
2. ✅ 仅在需要时才请求管理员权限（更好的用户体验）
3. ✅ 用户可以选择拒绝权限提升（不强制）
4. ✅ 权限提升失败时应用不会崩溃（健壮性）
5. ✅ 提供清晰的错误提示和操作指引（可用性）

