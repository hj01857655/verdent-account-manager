# Tauri 打包问题修复记录

## 问题 1: vue-tsc 版本兼容性错误

### 错误信息
```
Search string not found: "/supportedTSExtensions = .*(?=;)/"
beforeBuildCommand `npm run build` failed with exit code 1
```

### 原因
`vue-tsc` 1.8.0 版本与 TypeScript 5.3+ 不兼容

### 解决方案
1. **升级 vue-tsc**: 从 `^1.8.0` 升级到 `^2.0.0`
2. **修改构建脚本**: 将默认 `build` 脚本改为跳过类型检查,提高打包速度
   - `build`: `vite build` (快速打包,跳过类型检查)
   - `build:check`: `vue-tsc --noEmit && vite build` (完整检查)

### 修改文件
- `Verdent_account_manger/package.json`

### 验证
```bash
cd Verdent_account_manger
npm install
npm run build
```

**结果**: ✅ 构建成功

---

## 问题 2: Tauri 资源路径配置错误

### 错误信息
```
resource path `resources\verdent_auto_register.exe` doesn't exist
```

### 原因
Tauri 的 `bundle.resources` 路径是相对于 `src-tauri` 目录的,而不是项目根目录。

**文件实际位置**: `Verdent_account_manger/resources/verdent_auto_register.exe`  
**配置中的路径**: `resources/verdent_auto_register.exe` (相对于 `src-tauri`)  
**实际查找位置**: `Verdent_account_manger/src-tauri/resources/verdent_auto_register.exe` ❌

### 解决方案

#### 1. 修改 `tauri.conf.json` 配置

**文件**: `Verdent_account_manger/src-tauri/tauri.conf.json`

**修改前**:
```json
{
  "bundle": {
    "resources": [
      "resources/verdent_auto_register.exe"
    ]
  }
}
```

**修改后**:
```json
{
  "bundle": {
    "resources": [
      "../resources/verdent_auto_register.exe"
    ]
  }
}
```

**说明**: 使用 `../` 相对路径指向上级目录的 `resources` 文件夹

---

#### 2. 修改 Rust 运行时资源查找逻辑

**文件**: `Verdent_account_manger/src-tauri/src/commands.rs`

**修改前**:
```rust
if let Ok(resource_path) = app_handle.path().resource_dir() {
    let exe_path = resource_path.join("resources").join("verdent_auto_register.exe");
    // ...
}
```

**修改后**:
```rust
if let Ok(resource_path) = app_handle.path().resource_dir() {
    // Tauri 打包后,资源文件会直接放在 resource_dir 下
    let exe_path = resource_path.join("verdent_auto_register.exe");
    // ...
}
```

**说明**: Tauri 打包后,`bundle.resources` 中的文件会被提取并直接放在 `resource_dir()` 下,不会保留原始的目录结构。

---

### 验证

#### 开发模式
```bash
cd Verdent_account_manger
npm run tauri dev
```

应该能找到 Python 脚本: `verdent_auto_register.py`

#### 生产模式 (打包后)
```bash
cd Verdent_account_manger
npm run tauri build
```

打包后的资源文件位置:
- **安装前**: `Verdent_account_manger/src-tauri/target/release/bundle/msi/` (MSI 安装包)
- **安装后**: `C:\Program Files\Verdent账号管理器\` (安装目录)
- **资源目录**: 应用会在运行时通过 `app_handle.path().resource_dir()` 找到资源

---

## 文件路径总结

### 开发环境
```
Verdent/
├── verdent_auto_register.py          # Python 脚本 (开发模式使用)
└── Verdent_account_manger/
    ├── resources/
    │   └── verdent_auto_register.exe  # Python 打包的 exe (准备打包)
    └── src-tauri/
        ├── tauri.conf.json            # 配置: ../resources/verdent_auto_register.exe
        └── src/
            └── commands.rs            # 运行时查找逻辑
```

### 生产环境 (打包后)
```
安装目录/
├── verdent-account-manager.exe        # 主程序
└── verdent_auto_register.exe          # 资源文件 (从 bundle.resources 提取)
```

---

## 下一步

1. **测试打包**:
   ```bash
   cd Verdent_account_manger
   npm run tauri build
   ```

2. **验证生成的安装包**:
   - MSI: `Verdent_account_manger\src-tauri\target\release\bundle\msi\`
   - NSIS: `Verdent_account_manger\src-tauri\target\release\bundle\nsis\`

3. **测试安装和运行**:
   - 在干净的 Windows 环境中安装
   - 测试自动注册功能
   - 验证随机密码生成功能

---

---

## 问题 3: 打包后资源文件路径错误

### 错误信息
```
自动注册失败: 未找到自动注册可执行文件。
请确保:
- 开发模式: verdent_auto_register.py 在项目根目录
- 生产模式: verdent_auto_register.exe 已打包到 resources 目录
```

### 原因
Tauri 2.0 打包后,资源文件实际位置在 `_up_\resources` 目录下,而不是直接在 `resource_dir` 下。

### 解决方案

#### 增强资源查找逻辑

**文件**: `Verdent_account_manger/src-tauri/src/commands.rs`

**修改内容**:
1. 添加多个可能的资源路径查找
2. 添加详细的调试输出
3. 列出 resource_dir 目录内容以便诊断

**查找路径顺序**:
```rust
let exe_candidates = vec![
    // 直接在 resource_dir 下
    resource_path.join("verdent_auto_register.exe"),
    // 在 resources 子目录下
    resource_path.join("resources").join("verdent_auto_register.exe"),
    // 在 _up_/resources 下 (Tauri 2.0 某些情况)
    resource_path.join("_up_").join("resources").join("verdent_auto_register.exe"),
];
```

**调试输出**:
- 打印当前工作目录
- 打印 Tauri resource_dir 路径
- 列出 resource_dir 的所有文件和子目录
- 打印每个尝试的路径及是否存在

### 验证方法

从命令行启动打包后的应用,查看控制台输出:
```bash
cd "C:\Program Files\Verdent账号管理器"
.\verdent-account-manager.exe
```

预期看到类似输出:
```
[*] ========== 开始查找可执行文件 ==========
[*] Tauri resource_dir: C:\...\\_up_\resources
[*] resource_dir 目录内容:
    - verdent_auto_register.exe
[✓] 找到生产模式 exe 文件
```

---

## 问题 4: 缺少应用图标

### 错误信息
```
failed to bundle project `Couldn't find a .ico icon`
```

### 原因
`tauri.conf.json` 中 `bundle.icon` 配置为空数组 `[]`

### 解决方案

**文件**: `Verdent_account_manger/src-tauri/tauri.conf.json`

**修改前**:
```json
{
  "bundle": {
    "icon": []
  }
}
```

**修改后**:
```json
{
  "bundle": {
    "icon": ["icons/icon.ico"]
  }
}
```

**说明**: 图标文件 `icons/icon.ico` 已存在,只需在配置中引用即可。

---

## 修复状态

- [x] vue-tsc 版本兼容性问题
- [x] Tauri 资源路径配置
- [x] Rust 运行时资源查找逻辑 (增强版)
- [x] 应用图标配置
- [ ] 完整打包测试 (待执行)
- [ ] 安装包功能验证 (待执行)

