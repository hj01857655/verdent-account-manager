# 测试资源查找功能

## 问题描述

打包后的应用报错:
```
自动注册失败: 未找到自动注册可执行文件。
请确保:
- 开发模式: verdent_auto_register.py 在项目根目录
- 生产模式: verdent_auto_register.exe 已打包到 resources 目录
```

实际情况: 资源文件在 `_up_\resources` 目录下

## 已实施的修复

### 1. 增强资源查找逻辑

修改了 `Verdent_account_manger/src-tauri/src/commands.rs` 中的 `find_register_executable()` 函数:

**新增的查找路径**:
1. `resource_dir/verdent_auto_register.exe` (直接在 resource_dir 下)
2. `resource_dir/resources/verdent_auto_register.exe` (在 resources 子目录)
3. `resource_dir/_up_/resources/verdent_auto_register.exe` (Tauri 2.0 特殊路径)

**新增的调试功能**:
- 打印当前工作目录
- 打印 Tauri resource_dir 路径
- 列出 resource_dir 目录的所有内容
- 打印每个尝试的路径

### 2. 配置文件修复

**tauri.conf.json**:
```json
{
  "bundle": {
    "icon": ["icons/icon.ico"],
    "resources": ["../resources/verdent_auto_register.exe"]
  }
}
```

## 测试步骤

### 开发模式测试
```bash
cd Verdent_account_manger
npm run tauri dev
```

**预期输出**:
```
[*] ========== 开始查找可执行文件 ==========
[*] 当前工作目录: F:\Trace\TEST\Verdent\Verdent_account_manger\src-tauri
[!] 无法获取 resource_dir (可能在开发模式)
[*] 尝试查找开发模式 Python 脚本...
[*] 检查开发模式脚本: F:\Trace\TEST\Verdent\Verdent_account_manger\src-tauri\verdent_auto_register.py
[*] 检查开发模式脚本: F:\Trace\TEST\Verdent\Verdent_account_manger\verdent_auto_register.py
[*] 检查开发模式脚本: F:\Trace\TEST\Verdent\verdent_auto_register.py
[✓] 找到开发模式 Python 脚本: F:\Trace\TEST\Verdent\verdent_auto_register.py
```

### 生产模式测试 (打包后)

1. **重新编译**:
```bash
cd Verdent_account_manger\src-tauri
cargo build --release
```

2. **重新打包**:
```bash
cd ..
npm run tauri build
```

3. **安装并运行应用**

4. **查看控制台输出** (如果应用以控制台模式运行):
```
[*] ========== 开始查找可执行文件 ==========
[*] 当前工作目录: C:\Program Files\Verdent账号管理器
[*] Tauri resource_dir: C:\Program Files\Verdent账号管理器\_up_\resources
[*] 检查生产模式 exe: C:\Program Files\Verdent账号管理器\_up_\resources\verdent_auto_register.exe
[*] 检查生产模式 exe: C:\Program Files\Verdent账号管理器\_up_\resources\resources\verdent_auto_register.exe
[*] 检查生产模式 exe: C:\Program Files\Verdent账号管理器\_up_\resources\_up_\resources\verdent_auto_register.exe
[✓] 找到生产模式 exe 文件: C:\Program Files\Verdent账号管理器\_up_\resources\verdent_auto_register.exe
```

## 如何查看调试输出

### 方法 1: 从命令行启动应用
```bash
cd "C:\Program Files\Verdent账号管理器"
.\verdent-account-manager.exe
```

控制台会显示所有 `println!` 输出

### 方法 2: 修改为控制台应用 (临时调试)

在 `verdent_auto_register.spec` 中:
```python
exe = EXE(
    # ...
    console=True,  # 改为 True
)
```

在 `tauri.conf.json` 中添加:
```json
{
  "app": {
    "windows": [{
      "visible": true  // 确保窗口可见
    }]
  }
}
```

## 预期结果

✅ 应用能够在以下三个路径之一找到 `verdent_auto_register.exe`:
1. `resource_dir/verdent_auto_register.exe`
2. `resource_dir/resources/verdent_auto_register.exe`
3. `resource_dir/_up_/resources/verdent_auto_register.exe`

✅ 自动注册功能正常工作

## 如果仍然失败

1. **查看控制台输出的 "resource_dir 目录内容"**,确认文件实际位置
2. **根据实际路径调整代码**,在 `exe_candidates` 中添加新的路径
3. **检查文件权限**,确保应用有权限访问资源文件

## 下一步

重新打包并测试:
```bash
.\build_all.ps1
```

或分步执行:
```bash
# 1. 确保 Python exe 存在
.\build_python.ps1

# 2. 打包 Tauri 应用
.\build_tauri.ps1
```

